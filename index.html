<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geolocalizaci√≥n con Trazado de Ruta</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
            color: #333;
        }

        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        p {
            margin-bottom: 15px;
            text-align: center;
            max-width: 600px;
        }

        #map {
            height: 400px;
            width: 90%; /* Ajustado para mejor responsividad */
            max-width: 800px; /* Ancho m√°ximo para el mapa */
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .button-container {
            margin-top: 20px;
            display: flex;
            gap: 10px; /* Espacio entre botones */
        }

        button {
            background-color: #007bff;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #0056b3;
        }

        button#stopTrackingBtn {
            background-color: #dc3545; /* Rojo para detener */
        }

        button#stopTrackingBtn:hover {
            background-color: #bd2130;
        }

        #status-message {
            margin-top: 20px;
            font-weight: bold;
            color: #555;
            min-height: 20px; /* Para evitar saltos al cargar mensajes */
        }
    </style>
</head>
<body>
    <main>
        <h1>üó∫Ô∏è Geolocalizaci√≥n con Trazado de Ruta</h1>
        <p>Haz clic en "Iniciar Seguimiento" para ver tu ubicaci√≥n en tiempo real y trazar la ruta por donde te mueves. Luego, haz clic en "Detener Seguimiento" para finalizar.</p>

        <div class="button-container">
            <button id="startTrackingBtn">Iniciar Seguimiento</button>
            <button id="stopTrackingBtn" disabled>Detener Seguimiento</button>
        </div>
        <p id="status-message">Haz clic en "Iniciar Seguimiento" para comenzar...</p>

        <div id="map"></div>
    </main>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const statusMessage = document.getElementById("status-message");
        const startTrackingBtn = document.getElementById("startTrackingBtn");
        const stopTrackingBtn = document.getElementById("stopTrackingBtn");

        let map; // Referencia al mapa de Leaflet
        let marker; // Referencia al marcador de Leaflet
        let routeCoordinates = []; // Array para almacenar las coordenadas de la ruta
        let routePolyline; // Referencia a la polil√≠nea en el mapa
        let watchId; // ID del observador de posici√≥n para poder detenerlo

        const DEFAULT_ZOOM = 16; // Nivel de zoom por defecto, un poco m√°s cercano para ver el movimiento

        // Funci√≥n para iniciar el seguimiento de la ubicaci√≥n
        function startTracking() {
            if (navigator.geolocation) {
                statusMessage.textContent = "Iniciando seguimiento. Por favor, acepta la solicitud del navegador...";
                startTrackingBtn.disabled = true;
                stopTrackingBtn.disabled = false;
                routeCoordinates = []; // Reiniciar la ruta al iniciar
                if (routePolyline) {
                    map.removeLayer(routePolyline); // Eliminar la polil√≠nea anterior si existe
                }

                watchId = navigator.geolocation.watchPosition(
                    showPosition,
                    showError,
                    {
                        enableHighAccuracy: true,
                        timeout: 5000, // Tiempo m√°ximo para obtener cada actualizaci√≥n (5 segundos)
                        maximumAge: 0 // No usar una posici√≥n en cach√©
                    }
                );
            } else {
                statusMessage.textContent = "¬°Lo sentimos! Tu navegador no soporta la geolocalizaci√≥n. üòû";
            }
        }

        // Funci√≥n para detener el seguimiento de la ubicaci√≥n
        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
                statusMessage.textContent = "Seguimiento detenido. La ruta final est√° en el mapa.";
                startTrackingBtn.disabled = false;
                stopTrackingBtn.disabled = true;
            }
        }

        // Funci√≥n para manejar el √©xito al obtener la ubicaci√≥n
        function showPosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const newLatLng = [lat, lng];

            statusMessage.innerHTML = `Ubicaci√≥n actual: <br>Latitud: <strong>${lat.toFixed(6)}</strong>, Longitud: <strong>${lng.toFixed(6)}</strong>`;

            // Si el mapa a√∫n no ha sido inicializado
            if (!map) {
                map = L.map('map').setView(newLatLng, DEFAULT_ZOOM);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 19,
                    attribution: '¬© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
                }).addTo(map);

                marker = L.marker(newLatLng).addTo(map)
                    .bindPopup("¬°Est√°s aqu√≠!")
                    .openPopup();
            } else {
                // Si el mapa ya existe, actualiza la vista y el marcador
                map.setView(newLatLng, DEFAULT_ZOOM);
                marker.setLatLng(newLatLng);
                marker.setPopupContent("¬°Aqu√≠ est√°s ahora!").openPopup();
            }

            // A√±adir la nueva coordenada a la ruta
            routeCoordinates.push(newLatLng);

            // Dibujar o actualizar la polil√≠nea
            if (routePolyline) {
                routePolyline.setLatLngs(routeCoordinates); // Actualizar los puntos de la l√≠nea
            } else {
                // Crear la polil√≠nea la primera vez
                routePolyline = L.polyline(routeCoordinates, {color: 'blue', weight: 5, opacity: 0.7}).addTo(map);
            }
        }

        // Funci√≥n para manejar errores de geolocalizaci√≥n
        function showError(error) {
            let errorMessage = "Ocurri√≥ un error desconocido. üôÅ";
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage = "Permiso denegado. Para ver tu ubicaci√≥n, por favor permite el acceso a la geolocalizaci√≥n en tu navegador. üö´";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage = "Informaci√≥n de ubicaci√≥n no disponible. Int√©ntalo de nuevo m√°s tarde. üåê";
                    break;
                case error.TIMEOUT:
                    errorMessage = "La solicitud para obtener la ubicaci√≥n ha tardado demasiado. Aseg√∫rate de tener una buena conexi√≥n. ‚è≥";
                    break;
                case error.UNKNOWN_ERROR:
                    errorMessage = "Ocurri√≥ un error inesperado al obtener tu ubicaci√≥n. ü§î";
                    break;
            }
            statusMessage.textContent = `Error: ${errorMessage}`;
            startTrackingBtn.disabled = false; // Habilitar el bot√≥n de inicio de nuevo
            stopTrackingBtn.disabled = true; // Deshabilitar el bot√≥n de detener
            if (watchId) {
                navigator.geolocation.clearWatch(watchId); // Detener el seguimiento en caso de error
            }
        }

        // Event listeners para los botones
        startTrackingBtn.addEventListener('click', startTracking);
        stopTrackingBtn.addEventListener('click', stopTracking);
    </script>
</body>
</html>